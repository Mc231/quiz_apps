name: Reusable macOS Deploy

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Name of the app to deploy'
        required: true
        type: string
      app_path:
        description: 'Path to the app directory (e.g., apps/flagsquiz)'
        required: true
        type: string
      scheme:
        description: 'Xcode scheme name'
        required: false
        type: string
        default: 'Runner'
    secrets:
      FASTLANE_APPLE_ID:
        required: true
      FASTLANE_USER:
        required: true
      MACOS_PACKAGE_NAME:
        required: true
      MACOS_TEAM_ID:
        required: true
      FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD:
        required: true

jobs:
  macos_deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Bootstrap monorepo
        run: |
          dart pub get
          dart run melos bootstrap

      - name: Run tests for ${{ inputs.app_name }}
        working-directory: ${{ inputs.app_path }}
        run: flutter test --coverage

      - name: Build macOS
        working-directory: ${{ inputs.app_path }}
        run: flutter build macos --release

      - name: Deploy macOS
        working-directory: ${{ inputs.app_path }}/macos
        run: |
          bundle install
          bundle exec fastlane beta
        env:
          FASTLANE_APPLE_ID: ${{ secrets.FASTLANE_APPLE_ID }}
          FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
          MACOS_PACKAGE_NAME: ${{ secrets.MACOS_PACKAGE_NAME }}
          MACOS_TEAM_ID: ${{ secrets.MACOS_TEAM_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
