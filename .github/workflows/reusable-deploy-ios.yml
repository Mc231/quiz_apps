name: Reusable iOS Deploy

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Name of the app to deploy'
        required: true
        type: string
      app_path:
        description: 'Path to the app directory (e.g., apps/flagsquiz)'
        required: true
        type: string
      lane:
        description: 'Fastlane lane to run (beta, release)'
        required: false
        type: string
        default: 'beta'
    secrets:
      FASTLANE_APPLE_ID:
        required: true
      FASTLANE_USER:
        required: true
      IOS_PACKAGE_NAME:
        required: true
      IOS_TEAM_ID:
        required: true
      FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD:
        required: true

jobs:
  ios_deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Bootstrap monorepo
        run: |
          dart pub get
          dart run melos bootstrap

      - name: Run tests for ${{ inputs.app_name }}
        working-directory: ${{ inputs.app_path }}
        run: flutter test --coverage

      - name: Build and Deploy iOS (${{ inputs.lane }})
        working-directory: ${{ inputs.app_path }}/ios
        run: |
          bundle install
          bundle exec fastlane ${{ inputs.lane }}
        env:
          FASTLANE_APPLE_ID: ${{ secrets.FASTLANE_APPLE_ID }}
          FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
          IOS_PACKAGE_NAME: ${{ secrets.IOS_PACKAGE_NAME }}
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
